name: ğŸš€ æ„å»ºå¹¶æ¨é€åˆ°åˆ†æ”¯

on:
  push:
    branches:
      - main # åªæœ‰ main åˆ†æ”¯æœ‰æ–°çš„ push æ—¶æ‰è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»è®¾ç½®æ­¤æƒé™ï¼Œæ‰èƒ½å…è®¸ Actions å¾€ä»“åº“æ¨é€å†…å®¹

    steps:
      - name: ğŸ“¥ æ£€å‡º Yunzai æºç 
        uses: actions/checkout@v5
        with:
          repository: KaguyaJs/TRSS-Yunzai

      # 1. æ£€å‡º main åˆ†æ”¯ä»£ç  (åŒ…æ‹¬å®Œæ•´å†å²è®°å½•)
      - name: ğŸ“‚ æ£€å‡ºæ’ä»¶ä»£ç ï¼ˆplugins/temp-pluginï¼‰
        uses: actions/checkout@v5
        with:
          path: plugins/temp-plugin
          fetch-depth: 0

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # 3. å®‰è£… pnpm
      - name: ğŸ“¦ é…ç½® pnpm å¹¶å®‰è£…ä¾èµ–
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: |
            - args: ["--registry=https://registry.npmjs.org"]

      # 4. è¿è¡Œæ„å»ºå‘½ä»¤
      - name: ğŸ› ï¸ æ‰§è¡Œæ„å»ºï¼ˆpnpm run buildï¼‰
        run: |
          cd plugins/temp-plugin
          pnpm run build

      # 5. å‡†å¤‡è¦æäº¤åˆ° lib åˆ†æ”¯çš„æ–‡ä»¶
      - name: ğŸ“ å‡†å¤‡å‘å¸ƒæ‰€éœ€æ–‡ä»¶
        run: |
          cd plugins/temp-plugin

          mkdir -p temp_lib_content

          for f in $(jq -r '.files[]' package.json); do
            if [ -e "$f" ]; then
              dest="temp_lib_content/$f"
              mkdir -p "$(dirname "$dest")"
              cp -R "$f" "$dest"
              echo "[copy] $f"
            else
              echo "[skip] $f not exists"
            fi
          done

          echo "node_modules/" > temp_lib_content/.gitignore

      # åˆ é™¤å¼€å‘ä¾èµ–é¿å…ç”¨æˆ·å®‰è£…å¼€å‘ä¾èµ–å¢åŠ ä½“ç§¯
      - name: ğŸ§¹ ç§»é™¤å¼€å‘ä¾èµ–ï¼ˆå‡å°å‘å¸ƒä½“ç§¯ï¼‰
        run: |
          cd plugins/temp-plugin/temp_lib_content
          pnpm pkg delete devDependencies

      # 6. æ¨é€æ„å»ºäº§ç‰©åˆ° lib åˆ†æ”¯ (ä½¿ç”¨ actions-gh-pages)
      - name: ğŸ“¤ æ¨é€åˆ° lib åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        with:
          # è¿™æ˜¯ GitHub é»˜è®¤æä¾›çš„ Tokenï¼Œå…·æœ‰å†™å…¥æƒé™
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # è¦æ¨é€åˆ°çš„ç›®æ ‡åˆ†æ”¯
          publish_branch: lib
          # åŒ…å«è¦æ¨é€æ–‡ä»¶/ç›®å½•çš„æ–‡ä»¶å¤¹
          publish_dir: plugins/temp-plugin/temp_lib_content
          # æ¯æ¬¡æäº¤æ—¶ä¿ç•™å†å²è®°å½•
          force_orphan: false
          # è‡ªå®šä¹‰æäº¤ä¿¡æ¯
          full_commit_message: ${{ github.event.head_commit.message }}
          # å¦‚æœä½ å¸Œæœ›è‡ªå®šä¹‰æäº¤ç”¨æˆ·å/é‚®ç®±ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢ä¸¤è¡Œæ³¨é‡Šå¹¶ä¿®æ”¹
          # user_name: "github-actions[bot]"
          # user_email: "github-actions[bot]@users.noreply.github.com"
